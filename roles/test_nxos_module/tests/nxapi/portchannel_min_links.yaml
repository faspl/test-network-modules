---
- debug: msg="START nxapi/portchannel_min_links.yaml"

- name: ensure portchanel is configured with proper min-links
  nxos_portchannel:
    group: 11
    members: ['Ethernet1/6','Ethernet1/7']
    mode: 'active'
    min_links: '2'
    host: "{{ inventory_hostname }}"
    state: present
    transport: nxapi
    username: admin
    password: "!cisco123!"
  register: data

- assert:
    that:
      - data.changed == true
      - data.end_state['min_links'] == '2'

- name: idempotency check
  nxos_portchannel:
    group: 11
    members: ['Ethernet1/6','Ethernet1/7']
    mode: 'active'
    min_links: '2'
    host: "{{ inventory_hostname }}"
    state: present
    transport: nxapi
    username: admin
    password: "!cisco123!"
  register: data

- debug: var=data

- assert:
    that:
      - data.changed == false
      - data.end_state['min_links'] == '2'

- name: restore initial state
  nxos_portchannel:
    group: 11
    members: ['Ethernet1/6','Ethernet1/7']
    mode: 'active'
    min_links: '2'
    host: "{{ inventory_hostname }}"
    state: absent
    transport: nxapi
    username: admin
    password: "!cisco123!"
  register: data
