---
- debug: msg="START cli/portchannel_change_mode.yaml"

- name: prepare the device
  nxos_portchannel:
    group: 11
    members: ['Ethernet1/6','Ethernet1/7']
    mode: 'active'
    host: "{{ inventory_hostname }}"
    state: present
    transport: cli
    username: admin
    password: "!cisco123!"
  register: data

- name: change mode of an existing port-channel
  nxos_portchannel:
    group: 11
    members: ['Ethernet1/6','Ethernet1/7']
    mode: 'passive'
    host: "{{ inventory_hostname }}"
    state: present
    transport: cli
    username: admin
    password: "!cisco123!"
  register: data

- assert:
    that:
      - data.changed == true
      - data.end_state['mode'] == 'passive'

- name: idempotency check
  nxos_portchannel:
    group: 11
    members: ['Ethernet1/6','Ethernet1/7']
    mode: 'passive'
    host: "{{ inventory_hostname }}"
    state: present
    transport: cli
    username: admin
    password: "!cisco123!"
  register: data

- assert:
    that:
      - data.changed == false

- name: restore initial state
  nxos_portchannel:
    group: 11
    members: ['Ethernet1/6','Ethernet1/7']
    mode: 'passive'
    host: "{{ inventory_hostname }}"
    state: absent
    transport: cli
    username: admin
    password: "!cisco123!"
  register: data
